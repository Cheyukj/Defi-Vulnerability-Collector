import scrapy

class DefiSpider(scrapy.Spider):
    name = "defi_spider"
    allowed_domains = ["github.com"]

    def start_requests(self):
        urls = [
            ('https://github.com/slowmist', self.parse_example1),
            ('https://github.com/CertiKProject/Certified-DeFi', self.parse_example2),
            ('https://github.com/blocksecteam/defi_poc', self.parse_example3),
        ]
        for url, callback in urls:
            yield scrapy.Request(url=url, callback=callback)

    def parse_example1(self, response):
        # 解析 SlowMist GitHub 页面
        for repo in response.xpath('//div[contains(@class, "repo-list")]//li'):
            repo_name = repo.xpath('.//h3/a/text()').get(default='').strip()
            repo_description = repo.xpath('.//p/text()').get(default='').strip()
            yield {
                'site': 'slowmist',
                'repo_name': repo_name,
                'repo_description': repo_description,
            }

    def parse_example2(self, response):
        # 解析 CertiKProject/Certified-DeFi 仓库页面
        repo_name = response.xpath('//strong[@itemprop="name"]/a/text()').get(default='').strip()
        repo_description = response.xpath('//p[@itemprop="description"]/text()').get(default='').strip()
        last_commit = response.xpath('//relative-time/@datetime').get(default='').strip()
        yield {
            'site': 'CertiKProject/Certified-DeFi',
            'repo_name': repo_name,
            'repo_description': repo_description,
            'last_commit': last_commit,
        }

    def parse_example3(self, response):
        # 解析 blocksecteam/defi_poc 仓库页面
        repo_name = response.xpath('//strong[@itemprop="name"]/a/text()').get(default='').strip()
        repo_description = response.xpath('//p[@itemprop="description"]/text()').get(default='').strip()
        last_commit = response.xpath('//relative-time/@datetime').get(default='').strip()
        yield {
            'site': 'blocksecteam/defi_poc',
            'repo_name': repo_name,
            'repo_description': repo_description,
            'last_commit': last_commit,
        }
